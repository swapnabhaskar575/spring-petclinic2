version: 0.2
env:
  secrets-manager:
    LOGIN: prod/sonar:ecdb8a9a65eab5d2e8b0e2259f04df6807592cac
    HOST: prod/sonar:https://sonarcloud.io
    Organization: prod/sonar:swapnabhaskar575
    Project: prod/sonar:spring-petclinic2
phases:
    build:
    commands:
      - echo Build started on `date`
      - mvn clean install
      - mvn test
  Post_build:
    commands:
      - mvn test 
	  - mvn package		
      - mvn sonar:sonar -Dsonar.login=$LOGIN -Dsonar.host.url=$HOST -Dsonar.projectKey=$Project -Dsonar.organization=$Organization
      - sleep 5
      - curl https://sonarcloud.io/api/qualitygates/project_status?projectKey=$Project >result.json
      - cat result.json
      - if [ $(jq -r '.projectStatus.status' result.json) = ERROR ] ; then $CODEBUILD_BUILD_SUCCEEDING -eq 0 ;fi
